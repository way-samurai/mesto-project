(()=>{"use strict";const e=document.querySelector(".content"),t=(document.querySelector(".card-template").content,e.querySelector(".profile")),s=e.querySelector(".profile__info-box"),r=(s.querySelector(".info-box__name"),s.querySelector(".info-box__caption"),t.querySelector(".profile__avatar")),i=(t.querySelector(".profile__avatar-img"),document.querySelector("#editPopup")),n=s.querySelector(".info-box__edit-button"),o=i.querySelector(".popup__form"),a=(i.querySelector(".popup__input_data_name"),i.querySelector(".popup__input_data_operation"),o.querySelector(".popup__submit"),document.querySelector("#addPopup")),c=t.querySelector(".profile__add-button"),l=a.querySelector(".popup__form"),_=(l.querySelector(".popup__submit"),a.querySelector(".popup__input_data_name"),a.querySelector(".popup__input_data_operation"),document.querySelector("#confirm")),u=_.querySelector(".popup__form"),h=(u.querySelector(".popup__submit"),_.querySelector(".popup__close"),document.querySelector("#changeAvatarPopup")),d=h.querySelector(".popup__form"),p=(h.querySelector("#avatar-link"),h.querySelector(".popup__submit"),document.querySelector("#openImage"));p.querySelector(".popup__fullscreen-image"),p.querySelector(".popup__image-caption"),e.querySelector(".elements");const m=new class{constructor(e){this._baseUrl=e.baseUrl,this._headers=e.headers}_checkResponse=e=>e.ok?e.json():Promise.reject(`Что-то пошло не так: Ошибка ${e.status} - ${e.statusText}`);getUserInfo=()=>fetch(`${this._baseUrl}/users/me`,{method:"GET",headers:this._headers}).then(this._checkResponse);editUserInfo=(e,t)=>fetch(`${this._baseUrl}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:t})}).then(this._checkResponse);getInitialCards=()=>fetch(`${this._baseUrl}/cards`,{method:"GET",headers:this._headers}).then(this._checkResponse);addNewCard=(e,t)=>fetch(`${this._baseUrl}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:t})}).then(this._checkResponse);addHandleLikes=(e,t)=>fetch(`${this._baseUrl}/cards/likes/${e}`,{method:t,headers:this._headers}).then(this._checkResponse);deleteCard=e=>fetch(`${this._baseUrl}/cards/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkResponse);editUserAvatar=e=>fetch(`${this._baseUrl}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then(this._checkResponse)}({baseUrl:"https://nomoreparties.co/v1/plus-cohort-9",headers:{authorization:"cda53605-ab20-47f0-90b4-9efa5160708a","Content-Type":"application/json"}});class f{constructor({selector:e},t,s,r,i,n){this._selector=e,this._name=t.name,this._image=t.link,this._id=t._id,this._ownerId=t.owner._id,this._likes=t.likes,this._api=s,this._user=r,this._userId=r._id,this._card=t,this._handleCardClick=i,this._handleCardDelete=n,this._element=this._getElement(),this._cardTitle=this._element.querySelector(".place__title"),this._cardImage=this._element.querySelector(".place__image"),this._cardLikesCounter=this._element.querySelector(".place__likes-counter"),this._cardLikeButton=this._element.querySelector(".place__like-button"),this._cardDeleteButton=this._element.querySelector(".place__delete-button")}_getElement(){return document.querySelector(this._selector).content.querySelector(".place").cloneNode(!0)}generate(){return this._cardTitle.textContent=this._name,this._cardImage.src=this._image,this._cardImage.alt=this._name,this._cardDeleteButton.classList.toggle("place__delete-button_hidden",this._ownerId!==this._userId),this._checkLike(this._likes),this._setEventListeners(),this._element}_checkLike(e){this._cardLikesCounter.textContent=`${this._likes.length}`,e.some((e=>e._id===this._userId))&&this._cardLikeButton.classList.add("place__like-button_active")}_handleLikes(){const e=void 0!==this._likes.find((e=>e._id===this._userId))?"DELETE":"PUT";this._api.addHandleLikes(this._id,e).then((e=>{this._likes=e.likes,this._cardLikesCounter.textContent=`${this._likes.length}`,this._likes.some((e=>e._id===this._userId))?this._cardLikeButton.classList.add("place__like-button_active"):this._cardLikeButton.classList.remove("place__like-button_active")})).catch((e=>console.log(e)))}_setEventListeners(){this._cardLikeButton.addEventListener("click",(()=>{this._handleLikes()})),this._cardDeleteButton.addEventListener("click",(()=>{this._handleCardDelete(this._id,this._element)})),this._cardImage.addEventListener("click",(()=>{this._handleCardClick(this._name,this._image)}))}}class y{constructor(e,t){this._form=e,this._inactiveButtonClass=t.inactiveButtonClass,this._inputErrorClass=t.inputErrorClass,this._errorClass=t.errorClass,this._inputSelector=t.inputSelector,this._submitButtonSelector=t.submitButtonSelector,this._buttonElement=this._form.querySelector(this._submitButtonSelector)}_showInputError(e){this._errorElement=this._form.querySelector(`.${e.id}-error`),e.classList.add(this._inputErrorClass),this._errorElement.textContent=e.validationMessage,this._errorElement.classList.add(this._errorClass)}_hideInputError=e=>{this._errorElement=this._form.querySelector(`.${e.id}-error`),e.classList.remove(this._inputErrorClass),this._errorElement.classList.remove(this._errorClass),this._errorElement.textContent=""};_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e)}_toggleButtonState(){this._hasInvalidInput()?(this._buttonElement.classList.add(this._inactiveButtonClass),this._buttonElement.disabled=!0):(this._buttonElement.classList.remove(this._inactiveButtonClass),this._buttonElement.disabled=!1)}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}_setEventListeners(){this._inputList=Array.from(this._form.querySelectorAll(this._inputSelector)),this._toggleButtonState(),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))}))}enableValidation(){this._setEventListeners()}resetValidation(){this._toggleButtonState(),this._inputList.forEach((e=>{this._hideInputError(e)}))}}class S{constructor(e){this._selector=e,this._popup=document.querySelector(this._selector)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._closeByEscape)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._closeByEscape)}_closeByEscape=e=>{"Escape"===e.key&&this.close()};setEventListeners(){this._popup.addEventListener("mousedown",(e=>{e.target.classList.contains("popup_opened")&&this.close()})),this._popup.addEventListener("click",(e=>{e.target.closest(".popup__close")&&this.close()}))}renderLoading(e,t="Сохранить"){this._buttonSubmit.textContent=e?"Сохранение...":t}}class L extends S{constructor(e,t,s){super(e),this._handleFormSubmit=t,this._form=s,this._inputs=this._form.querySelectorAll(".popup__input"),this._buttonSubmit=this._form.querySelector(".popup__submit")}_getInputValues(){return this._formValues={},this._inputs.forEach((e=>{this._formValues[e.name]=e.value})),this._formValues}setInputValues(e){this._inputs.forEach((t=>{t.value=e[t.name]}))}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._handleFormSubmit(this._getInputValues())}))}close(){super.close(),this._form.reset()}}const v={};var g;g={inputErrorClass:"popup__input_type_error",errorClass:"popup__input-error_active",inactiveButtonClass:"popup__submit_disabled",formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__submit"},Array.from(document.querySelectorAll(g.formSelector)).forEach((e=>{const t=new y(e,g),s=e.getAttribute("name");v[s]=t,t.enableValidation()}));let b=null;const k=new class{constructor(e,t){this._renderer=e,this._container=document.querySelector(t)}addItem(e){const t=this._renderer(e);this._container.prepend(t)}renderItems(e){e.reverse().forEach((e=>{this.addItem(e)}))}}((function(e){return new f({selector:".card-template"},e,m,b,U,w).generate()}),".elements"),E=new class{constructor({nameInput:e,aboutInput:t,avatarLink:s}){this._nameInput=document.querySelector(e),this._aboutInput=document.querySelector(t),this._avatarLink=document.querySelector(s)}getInfoProfile(){return{username:this._nameInput.textContent,operation:this._aboutInput.textContent,avatarLink:this._avatarLink.src}}setUserInfo({name:e,about:t,avatar:s,_id:r}){this._nameInput.textContent=e,this._aboutInput.textContent=t,this._avatarLink.src=s}}({nameInput:".info-box__name",aboutInput:".info-box__caption",avatarLink:".profile__avatar-img"});Promise.all([m.getUserInfo(),m.getInitialCards()]).then((([e,t])=>{b=e,E.setUserInfo(b),k.renderItems(t)})).catch((e=>console.log(e)));const q=new class extends S{constructor(e,t,s){super(e),this._submitForm=t,this._form=s,this._buttonSubmit=this._form.querySelector(".popup__submit")}setEventListeners(){super.setEventListeners(),document.querySelector("#confirmDeleteButton").addEventListener("click",this._submitForm)}open(e,t){this._id=e,this.card=t,super.open()}}("#confirm",(function(){q.renderLoading(!0,"Да"),m.deleteCard(q._id).then((()=>{q.card.remove(),q.close()})).catch((e=>console.log(e))).finally((()=>{q.renderLoading(!1,"Да")}))}),u),I=new class extends S{constructor(e){super(e),this._imgTitle=document.querySelector(".popup__image-caption"),this._imgLink=document.querySelector(".popup__fullscreen-image")}open(e,t){super.open(),this._imgLink.src=t,this._imgTitle.alt=e,this._imgTitle.textContent=e}}("#openImage"),C=new L("#editPopup",(function(e){C.renderLoading(!0),m.editUserInfo(e.username,e.operation).then((e=>{E.setUserInfo(e),C.close()})).catch((e=>console.log(e))).finally((()=>{C.renderLoading(!1)}))}),o),B=new L("#changeAvatarPopup",(function(e){B.renderLoading(!0),m.editUserAvatar(e["avatar-link"]).then((e=>{E.setUserInfo(e),B.close()})).catch((e=>console.log(e))).finally((()=>{B.renderLoading(!1)}))}),d),x=new L("#addPopup",(function(e){x.renderLoading(!0,"Создать"),m.addNewCard(e.placename,e.imagelink).then((e=>{k.addItem(e),x.close()})).catch((e=>console.log(e))).finally((()=>{x.renderLoading(!1,"Создать")}))}),l);function U(e,t){I.open(e,t)}function w(e,t){q.open(e,t)}n.addEventListener("click",(()=>{C.setInputValues(E.getInfoProfile()),C.open(),v["profile-edit"].resetValidation()})),r.addEventListener("click",(()=>{B.open(),v.changeAvatar.resetValidation()})),c.addEventListener("click",(()=>{x.open(),v["add-places"].resetValidation()})),I.setEventListeners(),q.setEventListeners(),C.setEventListeners(),B.setEventListeners(),x.setEventListeners()})();